machine:
  services:
    - docker
  environment:
    NODE_ENV: development
dependencies:
  cache_directories:
    - "~/docker"
  override:
    - if [[ -e ~/docker/mongo.tar ]]; then docker load -i ~/docker/mongo.tar; fi
    - if [[ -e ~/docker/node.tar ]]; then docker load -i ~/docker/node.tar; fi
    - if [[ -e ~/docker/registry.tar ]]; then docker load -i ~/docker/registry.tar; fi
    - curl -L https://github.com/docker/compose/releases/download/1.2.0/docker-compose-`uname -s`-`uname -m` > ./docker-compose
    - chmod +x ./docker-compose
    - mv config/development.yml.sample config/development.yml
    - docker pull mongo:latest
    - docker pull node:0.12
    - docker pull registry:2
    - mkdir -p ~/docker; docker save mongo > ~/docker/mongo.tar
    - mkdir -p ~/docker; docker save node > ~/docker/node.tar
    - mkdir -p ~/docker; docker save registry > ~/docker/registry.tar
test:
  override:
    - sudo service mongodb stop
    - sudo service rabbitmq-server stop
    - ./docker-compose up -d
    - sleep 3
    - ./docker-compose run backend /bin/bash -c "npm install && npm test"
    - ./docker-compose start backend
    - ./docker-compose run registryproxy /bin/bash -c "npm install && npm test"
    - ./docker-compose run frontend /bin/bash -c "npm install && npm run build && npm test"
deployment:
  production:
    branch: master
    commands:
      - docker login -e kevin.simper@gmail.com -p $TUTUM_PASSWORD -u kevinsimper tutum.co
      - docker tag blackbeardapp_frontend tutum.co/kevinsimper/blackbeardapp_frontend
      - docker push tutum.co/kevinsimper/blackbeardapp_frontend
      - docker tag blackbeardapp_backend tutum.co/kevinsimper/blackbeardapp_backend
      - docker push tutum.co/kevinsimper/blackbeardapp_backend
      - docker tag blackbeardapp_registryproxy tutum.co/kevinsimper/blackbeardapp_registryproxy
      - docker push tutum.co/kevinsimper/blackbeardapp_registryproxy
      - ./docker-compose run -e NODE_ENV=production backend node migrate.js
experimental:
  notify:
    branches:
      only:
        - master
